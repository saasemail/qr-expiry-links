<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Auth — QR Expiry Links</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container" style="max-width:520px;">
    <section class="card" id="stateBox">
      <h2 id="title">Completing sign-in…</h2>
      <p class="hint" id="desc">Please wait a moment.</p>
      <div id="goHome" class="button-group" style="display:none; margin-top:1rem;">
        <a class="btn btn-primary" href="/">Return to app</a>
      </div>
    </section>
  </div>

  <script type="module">
    // ESM→UMD fallback za supabase (CSP-friendly)
    async function loadSupabaseCreateClient() {
      try {
        const mod = await import("https://esm.sh/@supabase/supabase-js@2");
        console.info("[auth] supabase via ESM");
        return mod.createClient;
      } catch (e) {
        console.warn("[auth] ESM failed, falling back to UMD:", e?.message || e);
        await new Promise((ok, err) => {
          const s = document.createElement("script");
          s.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js";
          s.async = true;
          s.onload = () => ok();
          s.onerror = () => err(new Error("UMD load failed"));
          document.head.appendChild(s);
        });
        if (!window.supabase?.createClient) throw new Error("supabase UMD not available");
        console.info("[auth] supabase via UMD");
        return (url, key, opts) => window.supabase.createClient(url, key, opts);
      }
    }

    const createClient = await loadSupabaseCreateClient();

    const SUPABASE_URL = "https://xyfacudywygreaquvzjr.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5ZmFjdWR5d3lncmVhcXV2empyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MjQ3MDcsImV4cCI6MjA3MjQwMDcwN30.9-fY6XV7BdPyto1l_xHw7pltmY2mBHj93bdVh418vSI";

    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { autoRefreshToken: true, persistSession: true, detectSessionInUrl: true },
    });

    const title = document.getElementById("title");
    const desc  = document.getElementById("desc");
    const goHome = document.getElementById("goHome");
    const setMsg = (t, d="") => { title.textContent = t; desc.textContent = d; };

    const hasAuthParams = () => {
      const u = new URL(window.location.href);
      return u.searchParams.has("code") || u.hash.includes("access_token") || u.hash.includes("type=");
    };

    async function finish() {
      try {
        if (hasAuthParams()) {
          try {
            await supa.auth.exchangeCodeForSession(window.location.href);
            console.info("[auth] exchange ok");
          } catch (e) {
            console.warn("[auth] exchange error:", e?.message || e);
          }
        }

        // kratka pauza da storage bude upisan
        await new Promise(r => setTimeout(r, 250));

        // getSession + fallback getUser
        let { data: { session } } = await supa.auth.getSession();
        if (!session) {
          const userRes = await supa.auth.getUser();
          if (userRes?.data?.user) session = { user: userRes.data.user };
        }

        // očisti URL (isti origin)
        history.replaceState(null, "", window.location.origin + "/auth.html");

        if (session?.user) {
          setMsg("You're signed in", "You can safely return to the app.");
          setTimeout(() => (window.location.href = "/"), 700);
        } else {
          setMsg("Signed in", "You can return to the app.");
          goHome.style.display = "";
        }
      } catch (e) {
        console.error("[auth] fatal:", e);
        setMsg("Auth error", e?.message || "Could not complete authentication.");
        goHome.style.display = "";
      }
    }

    finish();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Auth — QR Expiry Links</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container" style="max-width:520px;">
    <section class="card" id="stateBox">
      <h2 id="title">Completing sign-in…</h2>
      <p class="hint" id="desc">Please wait a moment.</p>
      <div id="goHome" class="button-group" style="display:none; margin-top:1rem;">
        <a class="btn btn-primary" href="/">Return to app</a>
      </div>
    </section>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://xyfacudywygreaquvzjr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5ZmFjdWR5d3lncmVhcXV2empyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MjQ3MDcsImV4cCI6MjA3MjQwMDcwN30.9-fY6XV7BdPyto1l_xHw7pltmY2mBHj93bdVh418vSI";

    // The SDK will auto-read #access_token and set the session.
    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { autoRefreshToken: true, persistSession: true, detectSessionInUrl: true },
    });

    const title = document.getElementById("title");
    const desc  = document.getElementById("desc");
    const goHome = document.getElementById("goHome");
    const setMsg = (t, d="") => { title.textContent = t; desc.textContent = d; };

    async function finish() {
      try {
        // tiny delay so SDK parses the URL hash
        await new Promise(r => setTimeout(r, 250));
        const { data: { session } } = await supa.auth.getSession();

        if (session) {
          setMsg("You're signed in", "You can safely return to the app.");
          setTimeout(() => (window.location.href = "/"), 800);
        } else {
          setMsg("Signed in", "You can return to the app.");
          goHome.style.display = "";
        }

        history.replaceState(null, "", location.origin + location.pathname);
      } catch (e) {
        setMsg("Auth error", e?.message || "Could not complete authentication.");
        goHome.style.display = "";
      }
    }

    finish();
  </script>
</body>
</html>

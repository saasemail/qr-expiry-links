<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Auth — QR Expiry Links</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container" style="max-width:520px;">
    <section class="card" id="stateBox">
      <h2 id="title">Authenticating…</h2>
      <p class="hint" id="desc">Please wait a moment.</p>

      <div id="resetBox" style="display:none; margin-top:1rem;">
        <label>
          New password
          <input type="password" id="newPwd1" placeholder="New password" autocomplete="new-password" />
        </label>
        <label>
          Repeat new password
          <input type="password" id="newPwd2" placeholder="Repeat new password" autocomplete="new-password" />
        </label>
        <div class="button-group">
          <button class="btn btn-primary" id="doReset" type="button">Update password</button>
        </div>
        <p class="hint" id="resetHint" style="text-align:center;"></p>
      </div>

      <div id="goHome" class="button-group" style="display:none; margin-top:1rem;">
        <a class="btn btn-primary" href="/">Return to app</a>
      </div>
    </section>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = window.NEXT_PUBLIC_SUPABASE_URL || "https://xyfacudywygreaquvzjr.supabase.co";
    const SUPABASE_ANON_KEY = window.NEXT_PUBLIC_SUPABASE_ANON_KEY ||
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5ZmFjdWR5d3lncmVhcXV2empyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MjQ3MDcsImV4cCI6MjA3MjQwMDcwN30.9-fY6XV7BdPyto1l_xHw7pltmY2mBHj93bdVh418vSI";

    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        flowType: "pkce",
        autoRefreshToken: true,
        persistSession: true,
        detectSessionInUrl: false, // ručno obrađujemo URL
      },
    });

    const title = document.getElementById("title");
    const desc  = document.getElementById("desc");
    const resetBox = document.getElementById("resetBox");
    const goHome = document.getElementById("goHome");
    const newPwd1 = document.getElementById("newPwd1");
    const newPwd2 = document.getElementById("newPwd2");
    const doReset = document.getElementById("doReset");
    const resetHint = document.getElementById("resetHint");

    function showHome(msgTitle, msgDesc) {
      title.textContent = msgTitle;
      desc.textContent = msgDesc || "";
      resetBox.style.display = "none";
      goHome.style.display = "";
    }
    function showReset() {
      title.textContent = "Reset password";
      desc.textContent = "Enter a new password for your account.";
      resetBox.style.display = "";
      goHome.style.display = "none";
    }
    function showError(msg) {
      title.textContent = "Auth error";
      desc.textContent = msg || "Could not complete authentication.";
      resetBox.style.display = "none";
      goHome.style.display = "";
    }

    async function completeFromUrl() {
      const url = new URL(window.location.href);
      const params = url.searchParams;
      const hash = url.hash || "";

      const type = params.get("type") || (hash.includes("type=recovery") ? "recovery" : null);
      const codeInQuery = params.get("code");
      const hasHashTokens = /access_token=/.test(hash) && /refresh_token=/.test(hash);
      const linkError = params.get("error_description") || params.get("error");

      try {
        if (linkError) {
          showError(linkError);
          return;
        }

        if (codeInQuery) {
          const { error } = await supa.auth.exchangeCodeForSession(window.location.href);
          if (error) throw error;
        } else if (hasHashTokens) {
          const at = hash.match(/access_token=([^&]+)/)?.[1];
          const rt = hash.match(/refresh_token=([^&]+)/)?.[1];
          if (!at || !rt) throw new Error("Missing tokens in URL hash");
          await supa.auth.setSession({
            access_token: decodeURIComponent(at),
            refresh_token: decodeURIComponent(rt),
          });
        } else {
          showError("No auth parameters found in the URL.");
          return;
        }

        // očisti URL
        history.replaceState(null, "", location.origin + location.pathname);

        if (type === "recovery") {
          showReset();
        } else {
          showHome("You're signed in", "You can safely return to the app.");
          setTimeout(() => (window.location.href = "/"), 900);
        }
      } catch (e) {
        showError(e?.message || "Authentication failed.");
      }
    }

    doReset?.addEventListener("click", async () => {
      resetHint.textContent = "";
      const p1 = newPwd1.value;
      const p2 = newPwd2.value;
      if (!p1 || !p2) { resetHint.textContent = "Enter and repeat the new password."; return; }
      if (p1 !== p2) { resetHint.textContent = "Passwords do not match."; return; }
      if (p1.length < 6) { resetHint.textContent = "Password must be at least 6 characters."; return; }

      try {
        const { error } = await supa.auth.updateUser({ password: p1 });
        if (error) { resetHint.textContent = error.message || "Could not update password."; return; }
        showHome("Password updated", "You can now log in with your new password.");
      } catch (e) {
        resetHint.textContent = e?.message || "Could not update password.";
      }
    });

    completeFromUrl();
  </script>
</body>
</html>
